<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ (–õ—ñ—á–∏–ª—å–Ω–∏–∫ –ï–Ω–µ—Ä–≥—ñ—ó) ‚ö°</title>
    <style>
        /* !!! –ö–õ–Æ–ß–û–í–ï –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ì–õ–û–ë–ê–õ–¨–ù–ò–ô BOX-SIZING !!! */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        /* ======================================================= */
        /* === –û–°–ù–û–í–ù–Ü –û–ü–¢–ò–ú–Ü–ó–ê–¶–Ü–á –î–õ–Ø –ú–û–ë–Ü–õ–¨–ù–û–á –í–ï–†–°–Ü–á (Mobile-First) === */
        /* ======================================================= */

        body {
            font-family: Arial, sans-serif;
            margin: 10px; 
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 650px;
            margin: 0 auto;
            background-color: #fff;
            padding: 15px; 
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* --- –û–ù–û–í–õ–ï–ù–ò–ô –°–¢–ò–õ–¨ –î–õ–Ø –ó–ê–ì–û–õ–û–í–ö–ê --- */
        h1 {
            color: #007bff;
            text-align: center;
            font-size: 1.6em; 
            margin-bottom: 0px; 
        }
        
        .h1-subtitle {
             color: #555;
             text-align: center;
             font-size: 0.9em; 
             margin-bottom: 15px;
             margin-top: 5px; 
             font-weight: normal;
             display: block;
        }

        h2.author {
            color: #555;
            text-align: center;
            font-size: 0.8em; 
            margin-bottom: 15px;
            margin-top: -8px; 
            font-weight: normal;
        }
        
        /* –ö–ª—é—á–æ–≤–∏–π —Å—Ç–∏–ª—å –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∑—É–º—É –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö */
        input[type="number"] {
            font-size: 16px; 
        }

        /* --- –°–¢–ò–õ–Ü –î–õ–Ø U, I, P (–ö–û–ñ–ï–ù –ë–õ–û–ö 100% –®–ò–†–ò–ù–ò) --- */

        /* –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ –≤—ñ–¥—Å—Ç—É–ø–∏ –º—ñ–∂ —É—Å—ñ–º–∞ –≤–≤—ñ–¥–Ω–∏–º–∏ –≥—Ä—É–ø–∞–º–∏ U, I, P */
        #voltageRow, #currentRow, #powerRow {
            margin-bottom: 10px; 
        }
        
        .styled-input-group {
            display: flex;
            flex-direction: column;
            border: 1px solid #dcdcdc; 
            border-radius: 15px;
            padding: 10px; 
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #fff;
        }

        .styled-input-group.filled {
            border-color: #28a745; 
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
            background-color: #e9f5e9; 
        }

        .styled-input-group label {
            text-align: center;
            font-weight: bold;
            font-size: 1em; 
            color: #333;
            margin-bottom: 5px; 
            order: 1;
        }

        .styled-input-group input {
            width: 100%;
            padding: 8px; 
            margin: 0;
            border: 1px solid #ccc; 
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em; 
            font-weight: bold;
            order: 2;
            background-color: transparent; 
        }
        
        /* –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –í–ò–î–ê–õ–ï–ù–ù–Ø –°–¢–ê–ù–î–ê–†–¢–ù–û–ì–û OUTLINE –ù–ê –§–û–ö–£–°–Ü */
        .styled-input-group input:focus {
            outline: none; 
            border-color: #007bff; 
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); 
        }
        
        .styled-input-group.filled input {
            border: 1px solid #28a745; 
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è "–ê–±–æ" */
        .or-separator {
            text-align: center;
            font-weight: bold;
            margin: 10px 0; 
            font-size: 1.1em; 
            color: #007bff;
        }
        
        /* === –°—Ç–∏–ª—å –¥–ª—è –ü–æ—Å—Ç—ñ–π–Ω–æ—ó –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ === */
        #meterConstantGroup {
             padding: 10px; 
             border: 1px solid #dcdcdc; 
             border-radius: 15px;
             transition: border-color 0.3s, box-shadow 0.3s;
             background-color: #fff;
             margin-bottom: 15px; 
        }
        
        #meterConstantGroup.filled {
             border-color: #28a745; 
             box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
             background-color: #e9f5e9; 
        }
        
        #meterConstantGroup label {
             text-align: center;
             margin-bottom: 8px; 
             display: block; 
        }

        #meterConstantGroup input {
            width: 100%;
            padding: 8px; 
            margin-bottom: 0; 
            border: 1px solid #ccc; 
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em; 
            font-weight: bold;
            background-color: transparent; 
        }
        
        /* –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –í–ò–î–ê–õ–ï–ù–ù–Ø –°–¢–ê–ù–î–ê–†–¢–ù–û–ì–û OUTLINE –ù–ê –§–û–ö–£–°–Ü */
        #meterConstantGroup input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }
        
        #meterConstantGroup.filled input {
            border: 1px solid #28a745; 
        }
        /* ============================================== */

        /* --- –°—Ç–∏–ª—ñ –¥–ª—è –∫–Ω–æ–ø–æ–∫-–ø–µ—Ä–µ–º–∏–∫–∞—á—ñ–≤ --- */

        .mode-button-group {
            display: flex;
            flex-direction: column; 
            gap: 10px;
            margin-bottom: 15px; 
        }
        .mode-button-group input[type="radio"] {
            display: none;
        }
        .mode-button-group label {
            flex-grow: 1;
            text-align: center;
            padding: 10px 15px; 
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 2px solid;
        }
        
        #modePulses + label { background-color: #fff7f0; color: #ff6a00; border-color: #ff6a00; }
        #modePulses:checked + label { background-color: #ff6a00; color: white; }
        #modeTime + label { background-color: #f0f7ff; color: #007bff; border-color: #007bff; }
        #modeTime:checked + label { background-color: #007bff; color: white; }
        
        .input-group {
            margin-bottom: 15px;
        }
        .hidden-input {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px dashed #ccc;
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è INPUT –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ hidden-input (–ö—ñ–ª—å–∫—ñ—Å—Ç—å —ñ–º–ø—É–ª—å—Å—ñ–≤) */
        #inputPulses input {
            width: 100%;
            padding: 8px; 
            margin: 5px 0 0; 
            border: 1px solid #ccc; 
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em; 
            font-weight: bold;
            background-color: white; 
        }
        
        /* –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –í–ò–î–ê–õ–ï–ù–ù–Ø –°–¢–ê–ù–î–ê–†–¢–ù–û–ì–û OUTLINE –ù–ê –§–û–ö–£–°–Ü */
        #inputPulses input:focus {
             outline: none;
             border-color: #007bff;
             box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –°–µ–∫—É–Ω–¥–æ–º—ñ—Ä–∞ */
        #timerSection {
            text-align: center;
            padding: 15px;
            margin-top: 10px; 
            border: 2px solid #28a745;
            border-radius: 8px;
            background-color: #f0fff0;
        }
        #timerDisplay {
            font-size: 2em; 
            font-weight: bold;
            margin-bottom: 10px; 
            color: #28a745;
        }
        .timer-buttons {
            display: flex; 
            gap: 10px; 
        }
        .timer-buttons button {
            flex-grow: 1; 
            padding: 15px 10px; 
            border: none;
            border-radius: 8px; 
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
            font-size: 1.1em; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        
        #startStopBtn { 
            background-color: #17a2b8; 
            flex-grow: 3; 
        }
        #resetBtn { 
            background-color: #6c757d; 
            flex-grow: 2; 
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –ë–õ–û–ö–£ –†–ï–ó–£–õ–¨–¢–ê–¢–Ü–í */
        #result {
            margin-top: 15px; 
            padding: 15px; 
            background-color: #e6f7ff; 
            border: 2px solid #007bff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.1);
            color: #1a1a1a;
        }

        #result p {
            font-size: 1em; 
            margin: 8px 0;
        }
        
        #result strong {
            font-weight: bold; 
            color: #007bff; 
        }
        
        /* === –°–¢–ò–õ–Ü –î–õ–Ø –î–û–í–Ü–î–ö–ò === */
        #reference {
            margin-top: 15px;
            padding: 15px; 
            background-color: #f8f9fa; 
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 0.9em; 
            color: #495057;
        }

        #reference h4 {
            color: #333;
            margin-top: 5px;
            margin-bottom: 8px;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 5px;
        }

        #reference .formula {
            font-family: 'Courier New', monospace;
            font-size: 1em; 
            color: #007bff; 
            display: block;
            margin: 10px 0;
            padding: 3px; 
            background-color: #e9ecef;
            border-radius: 4px;
            overflow-x: auto; 
        }
        
        #reference .value-list {
            margin-top: 10px;
            padding-left: 20px;
            list-style: disc;
        }
        
        #reference .value-list strong {
            color: #28a745; 
            font-weight: bold;
        }
        
        /* === –°–¢–ò–õ–¨ –î–õ–Ø –ü–Ü–î–í–ê–õ–£ –ó –ü–û–°–ò–õ–ê–ù–ù–Ø–ú (–ù–û–í–ò–ô) === */
        .footer-link {
            text-align: center;
            margin-top: 20px;
            padding-bottom: 10px;
            font-size: 0.9em;
        }

        .footer-link a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s;
        }

        .footer-link a:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        /* === MEDIA QUERY (–¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤/–¥–µ—Å–∫—Ç–æ–ø—ñ–≤) === */
        @media (min-width: 500px) {
            .mode-button-group {
                flex-direction: row; 
            }
            .container {
                padding: 25px; 
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>‚ö° –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ ‚ö°</h1>
    <span class="h1-subtitle">(–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó)</span> 
    <h2 class="author">Mykhailo Kryzhanivskyi</h2>

    <hr>
    <h2>1. –¢–µ—Ö–Ω—ñ—á–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏</h2>
    
    <div class="input-group" id="voltageRow"> 
        <div id="voltageGroup" class="styled-input-group">
            <label for="voltage">–ù–∞–ø—Ä—É–≥–∞ (U), –í</label>
            <input type="number" id="voltage" value="" required min="1" 
                   oninput="handleInputExclusion('voltage'); checkAndToggleFilled('voltage'); calculate();" 
                   placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥ 230">
        </div>
    </div>
    
    <div class="input-group" id="currentRow"> 
        <div id="currentGroup" class="styled-input-group">
            <label for="current">–°—Ç—Ä—É–º (I), –ê</label>
            <input type="number" id="current" value="" required min="0.1" 
                   oninput="handleInputExclusion('current'); checkAndToggleFilled('current'); calculate();" 
                   placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥ 16">
        </div>
    </div>
    
    <div class="or-separator">–ê–±–æ</div>
    
    <div class="input-group" id="powerRow">
        <div id="powerGroup" class="styled-input-group">
            <label for="powerMeasured">–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å (P), –∫–í—Ç</label>
            <input type="number" id="powerMeasured" value="" min="0.01" 
                   oninput="handleInputExclusion('power'); checkAndToggleFilled('powerMeasured'); calculate();">
        </div>
    </div>
    
    <div class="input-group" id="meterConstantGroup">
        <label for="meterConstant">–ü–æ—Å—Ç—ñ–π–Ω–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ (C), —ñ–º–ø/–∫–í—Ç¬∑–≥–æ–¥:</label>
        <input type="number" id="meterConstant" value="" required min="1" 
               oninput="checkAndToggleFilled('meterConstant'); calculate()" 
               placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 6400"> </div>

    <hr>

    <h2>2. –†–µ–∂–∏–º —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É</h2>

    <div class="mode-button-group">
        <input type="radio" id="modePulses" name="calculationMode" value="pulses" checked onchange="toggleCalcInputs(); calculate();">
        <label for="modePulses">‚è±Ô∏è –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ **–Ü–ú–ü–£–õ–¨–°–ò** (N)</label>

        <input type="radio" id="modeTime" name="calculationMode" value="time" onchange="toggleCalcInputs(); calculate();">
        <label for="modeTime">üìä –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ **–ß–ê–°** (t)</label>
    </div>
    
    <div id="inputTime" class="hidden-input" style="display: block;">
        <div id="timerSection">
            <div id="timerDisplay">00:00:00.00</div>
            <div class="timer-buttons">
                <button id="startStopBtn" onclick="toggleTimer()">–°–¢–ê–†–¢</button>
                <button id="resetBtn" onclick="resetTimer()">–°–ö–ò–î–ê–ù–ù–Ø</button>
            </div>
        </div>
    </div>
    
    <div id="inputPulses" class="hidden-input">
        <label for="pulses">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —ñ–º–ø—É–ª—å—Å—ñ–≤ (N):</label>
        <input type="number" id="pulses" value="" required min="1" oninput="calculate()" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 20">
    </div>


    <hr>

    <h3>3. –†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
    <div id="result">
        –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É.
    </div>
    
    <hr>

    <h3>4. –î–æ–≤—ñ–¥–∫–∞ (–î–µ—Ç–∞–ª—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É)</h3>
    <div id="reference">
        –¢—É—Ç –±—É–¥–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ —Ñ–æ—Ä–º—É–ª–∏ —Ç–∞ –ø—Ä–æ–º—ñ–∂–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è.
    </div>

</div> <div class="footer-link">
    –ó–≤–æ—Ä–æ—Ç–Ω–∏–π –∑–≤'—è–∑–æ–∫: <a href="https://t.me/IcyMike" target="_blank">@IcyMike (Telegram)</a>
</div>
<script>
    let timerInterval;
    let startTime;
    let elapsedTime = 0; // –ß–∞—Å –≤ –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥–∞—Ö

    /**
     * –î–∏–Ω–∞–º—ñ—á–Ω–æ –¥–æ–¥–∞—î/–≤–∏–¥–∞–ª—è—î –∫–ª–∞—Å 'filled' –¥–ª—è –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –ø–æ–ª—è.
     */
    function checkAndToggleFilled(inputId) {
        const inputElement = document.getElementById(inputId);
        let groupId;
        if (inputId === 'voltage') groupId = 'voltageGroup';
        else if (inputId === 'current') groupId = 'currentGroup';
        else if (inputId === 'powerMeasured') groupId = 'powerGroup';
        else if (inputId === 'meterConstant') groupId = 'meterConstantGroup'; 
        
        const groupElement = document.getElementById(groupId);

        if (inputElement.value.trim() !== '') {
            groupElement.classList.add('filled');
        } else {
            groupElement.classList.remove('filled');
        }
    }

    function handleInputExclusion(changedField) {
        const voltageInput = document.getElementById('voltage');
        const currentInput = document.getElementById('current');
        const powerInput = document.getElementById('powerMeasured');
        
        const updateFilledClasses = () => {
             checkAndToggleFilled('voltage');
             checkAndToggleFilled('current');
             checkAndToggleFilled('powerMeasured');
             checkAndToggleFilled('meterConstant'); 
        };

        if (changedField === 'power') {
            if (powerInput.value !== '') {
                voltageInput.value = '';
                currentInput.value = '';
            }
        } else if (changedField === 'voltage' || changedField === 'current') {
            if (voltageInput.value !== '' || currentInput.value !== '') {
                powerInput.value = '';
            }
        }
        
        updateFilledClasses();
    }

    function formatTime(ms) {
        let totalSeconds = Math.floor(ms / 1000);
        let hours = Math.floor(totalSeconds / 3600);
        let minutes = Math.floor((totalSeconds % 3600) / 60);
        let seconds = totalSeconds % 60;
        let milliseconds = Math.floor((ms % 1000) / 10); 

        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
    }
    
    function formatHoursMinutesSeconds(t_hours) {
        let hours = Math.floor(t_hours);
        let totalMinutes = (t_hours - hours) * 60;
        let minutes = Math.floor(totalMinutes);
        let seconds = Math.round((totalMinutes - minutes) * 60);
        
        return `${hours} –≥–æ–¥ ${minutes} —Ö–≤ ${seconds} —Å–µ–∫`;
    }

    function toggleCalcInputs() {
        const mode = document.querySelector('input[name="calculationMode"]:checked').value;
        
        const inputTimeDiv = document.getElementById('inputTime');
        const inputPulsesDiv = document.getElementById('inputPulses');
        
        if (mode === 'pulses') {
            inputTimeDiv.style.display = 'block';
            inputPulsesDiv.style.display = 'none';
        } else { // mode === 'time'
            inputTimeDiv.style.display = 'none';
            inputPulsesDiv.style.display = 'block';
        }
        
        if (timerInterval) {
            stopTimer(false); 
        }
        elapsedTime = 0;
        document.getElementById('timerDisplay').textContent = "00:00:00.00"; 
        document.getElementById('startStopBtn').textContent = "–°–¢–ê–†–¢";
        document.getElementById('startStopBtn').style.backgroundColor = "#17a2b8";
        
        calculate();
    }

    // --- –§–£–ù–ö–¶–Ü–á –°–ï–ö–£–ù–î–û–ú–Ü–†–ê ---

    function updateTimerDisplay() {
        const now = Date.now();
        elapsedTime = now - startTime;
        document.getElementById('timerDisplay').textContent = formatTime(elapsedTime);
    }

    function startTimer() {
        if (timerInterval) return; 
        
        document.getElementById('result').innerHTML = "‚è±Ô∏è **–°–µ–∫—É–Ω–¥–æ–º—ñ—Ä –ø—Ä–∞—Ü—é—î...** –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **–°–¢–û–ü** –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É.";
        
        startTime = Date.now() - elapsedTime;
        timerInterval = setInterval(updateTimerDisplay, 10); 
        
        document.getElementById('startStopBtn').textContent = "–°–¢–û–ü";
        document.getElementById('startStopBtn').style.backgroundColor = "#dc3545";
        
        document.getElementById('reference').innerHTML = "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –Ω–∞ –∑—É–ø–∏–Ω–∫—É —Å–µ–∫—É–Ω–¥–æ–º—ñ—Ä–∞ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É...";
    }

    function stopTimer(doCalculation = true) {
        if (!timerInterval) return;
        clearInterval(timerInterval);
        timerInterval = null;

        document.getElementById('startStopBtn').textContent = "–°–¢–ê–†–¢";
        document.getElementById('startStopBtn').style.backgroundColor = "#17a2b8";
        
        if (doCalculation) {
            calculateFromTimer(elapsedTime);
        }
    }

    function toggleTimer() {
        if (timerInterval) {
            stopTimer(true);
        } else {
            startTimer();
        }
    }

    function resetTimer() {
        stopTimer(false); 
        elapsedTime = 0;
        document.getElementById('timerDisplay').textContent = "00:00:00.00"; 
        calculate();
    }

    /**
     * –†–æ–∑—Ä–∞—Ö–æ–≤—É—î –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å.
     */
    function calculatePower(U, I, P_measured) {
        if (!isNaN(P_measured) && P_measured > 0) {
            return P_measured;
        }
        
        if (isNaN(U) || isNaN(I) || U <= 0 || I <= 0) {
            return null; 
        }
        
        const phaseFactor = 1; 
        const CT = 1; 
        
        return (phaseFactor * U * I * CT) / 1000;
    }

    /**
     * –ì–µ–Ω–µ—Ä—É—î HTML-–∫–æ–¥ –¥–ª—è –¥–æ–≤—ñ–¥–∫–∏.
     */
    function generateReferenceHTML(calcMode, U, I, P_measured, C, N_input, timeMs, P_kW_calculated, N_pulses, t_hours) {
        let html = '';
        let formulaPower = '';
        let valuesPower = [];
        
        const multiplicationDot = '\u00B7'; 

        // 1. –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ü–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ (P)
        html += '<h4>1. –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ü–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ (P)</h4>';
        if (!isNaN(P_measured) && P_measured > 0) {
            formulaPower = `P = P\u208B\u043C\u0456\u0440\u044F\u043D\u0430`;
            valuesPower.push(`P\u208B\u043C\u0456\u0440\u044F\u043D\u0430 (–≤–≤–µ–¥–µ–Ω–∞): <strong>${P_measured}</strong> –∫–í—Ç`);
            valuesPower.push(`P (–†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å): <strong>${P_kW_calculated.toFixed(3)}</strong> –∫–í—Ç`);
        } else if (!isNaN(U) && !isNaN(I) && P_kW_calculated !== null) {
            formulaPower = `P = (U ${multiplicationDot} I) / 1000 (–∑–∞ —É–º–æ–≤–∏ cos(\u03C6) \u2248 1)`;
            valuesPower.push(`U (–ù–∞–ø—Ä—É–≥–∞): <strong>${U}</strong> –í`);
            valuesPower.push(`I (–°—Ç—Ä—É–º): <strong>${I}</strong> –ê`);
            valuesPower.push(`P = (${U} ${multiplicationDot} ${I}) / 1000 = <strong>${P_kW_calculated.toFixed(3)}</strong> –∫–í—Ç`);
        } else {
             return "–î–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ–≤—ñ–¥–∫–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –≤–≤–µ—Å—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ (U —Ç–∞ I, –∞–±–æ P).";
        }
        
        html += `<code class="formula">${formulaPower}</code>
                 <ul class="value-list">
                    ${valuesPower.map(v => `<li>${v}</li>`).join('')}
                    <li>–ü–æ—Å—Ç—ñ–π–Ω–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ (C): <strong>${C}</strong> —ñ–º–ø/–∫–í—Ç\u00B7–≥–æ–¥</li>
                 </ul>`;

        // 2. –û—Å–Ω–æ–≤–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
        if (calcMode === 'pulses' && timeMs !== null && timeMs > 0) {
            const t_seconds = timeMs / 1000;
            const t_seconds_fixed = t_seconds.toFixed(2);
            
            html += `<h4>2. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –Ü–º–ø—É–ª—å—Å—ñ–≤ (N)</h4>
                     <p>–§–æ—Ä–º—É–ª–∞ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —ñ–º–ø—É–ª—å—Å—ñ–≤, –±–∞–∑—É—é—á–∏—Å—å –Ω–∞ –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ —Ç–∞ —á–∞—Å—ñ (—É —Å–µ–∫—É–Ω–¥–∞—Ö):</p>`;

            html += `<code class="formula">N = (P ${multiplicationDot} t\u208B\u0441\u0435\u043A ${multiplicationDot} C) / 3600</code>
                     <ul class="value-list">
                        <li>–ó–∞–º—ñ—Ä—è–Ω–∏–π –ß–∞—Å (t\u208B\u0441\u0435\u043A): <strong>${t_seconds_fixed}</strong> —Å–µ–∫</li>
                        <li>N = (${P_kW_calculated.toFixed(3)} ${multiplicationDot} ${t_seconds_fixed} ${multiplicationDot} ${C}) / 3600 = <strong>${N_pulses.toFixed(2)}</strong> —ñ–º–ø</li>
                     </ul>`;

        } else if (calcMode === 'time' && N_input > 0) {
            const E_kWh = N_input / C; 
            const t_hours = E_kWh / P_kW_calculated;
            const t_seconds = t_hours * 3600; 
            const t_seconds_fixed = t_seconds.toFixed(2);
            
            html += `<h4>2. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ß–∞—Å—É (t)</h4>
                     <p>–§–æ—Ä–º—É–ª–∞ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –æ—á—ñ–∫—É–≤–∞–Ω–æ–≥–æ —á–∞—Å—É (—É —Å–µ–∫—É–Ω–¥–∞—Ö), –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ–≥–æ –¥–ª—è N —ñ–º–ø—É–ª—å—Å—ñ–≤:</p>`;

            html += `<code class="formula">t\u208B\u0441\u0435\u043A = (N ${multiplicationDot} 3600) / (C ${multiplicationDot} P)</code>
                     <ul class="value-list">
                        <li>–í–≤–µ–¥–µ–Ω—ñ –Ü–º–ø—É–ª—å—Å–∏ (N): <strong>${N_input}</strong> —ñ–º–ø</li>
                        <li>t\u208B\u0441\u0435\u043A = (${N_input} ${multiplicationDot} 3600) / (${C} ${multiplicationDot} ${P_kW_calculated.toFixed(3)})</li>
                        <li>t\u208B\u0441\u0435\u043A (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö): <strong>${t_seconds_fixed}</strong> —Å–µ–∫</li>
                        <li>t (—É —Ñ–æ—Ä–º–∞—Ç—ñ –ì:–•:–°): <strong>${formatHoursMinutesSeconds(t_hours)}</strong></li>
                     </ul>`;
        } else {
             return "–î–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ–≤—ñ–¥–∫–∏ –≤–∏–∫–æ–Ω–∞–π—Ç–µ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫, –≤–≤—ñ–≤—à–∏ –≤—Å—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ.";
        }
        
        return html;
    }


    function calculateFromTimer(timeMs) {
        if (document.querySelector('input[name="calculationMode"]:checked').value !== 'pulses') {
            return;
        }
        
        const U = parseFloat(document.getElementById('voltage').value); 
        const I = parseFloat(document.getElementById('current').value); 
        const C = parseFloat(document.getElementById('meterConstant').value); 
        const P_measured = parseFloat(document.getElementById('powerMeasured').value);
        const resultDiv = document.getElementById('result');
        const referenceDiv = document.getElementById('reference');

        if (isNaN(C) || C <= 0) {
             resultDiv.innerHTML = "‚ùå **–ü–æ–º–∏–ª–∫–∞:** –í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É **–ü–æ—Å—Ç—ñ–π–Ω—É** –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞.";
             referenceDiv.innerHTML = "–í–≤–µ–¥—ñ—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É.";
             return;
        }

        const P_kW_calculated = calculatePower(U, I, P_measured);

        if (P_kW_calculated === null || P_kW_calculated <= 0) {
            resultDiv.innerHTML = "‚ùå **–ü–æ–º–∏–ª–∫–∞:** –í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è **–ü–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ (P)** –ê–ë–û –∑–∞–ø–æ–≤–Ω—ñ—Ç—å **–ù–∞–ø—Ä—É–≥—É (U)** —Ç–∞ **–°—Ç—Ä—É–º (I)**.";
            referenceDiv.innerHTML = "–í–≤–µ–¥—ñ—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É.";
            return;
        }
        
        if (timeMs === 0) {
            resultDiv.innerHTML = "‚ö†Ô∏è **–ü–æ–º–∏–ª–∫–∞:** –°–µ–∫—É–Ω–¥–æ–º—ñ—Ä –∑—É–ø–∏–Ω–µ–Ω–æ –Ω–∞ 00:00:00.00. –°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –°–¢–ê–†–¢.";
            referenceDiv.innerHTML = "–í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è —á–∞—Å—É –Ω–µ –±—É–ª–æ —Ä–æ–∑–ø–æ—á–∞—Ç–æ.";
            return;
        }

        const t_hours = timeMs / 3600000; 
        const E_kWh = P_kW_calculated * t_hours; 
        const N_pulses = E_kWh * C;

        let totalSeconds = Math.floor(timeMs / 1000);
        let hours = Math.floor(totalSeconds / 3600);
        let minutes = Math.floor((totalSeconds % 3600) / 60);
        let seconds = totalSeconds % 60;
        let hundredths = Math.floor((timeMs % 1000) / 10); 

        const detailedTimeResult = `
            ${String(hours).padStart(2, '0')} –≥–æ–¥ 
            ${String(minutes).padStart(2, '0')} —Ö–≤ 
            ${String(seconds).padStart(2, '0')} —Å–µ–∫ 
            ${String(hundredths).padStart(2, '0')} –º—Å
        `.trim().replace(/\s+/g, ' '); 
        
        resultDiv.innerHTML = `
            <p>‚úÖ **–†–û–ó–†–ê–•–£–ù–û–ö –ó–ê –ß–ê–°–û–ú (–†–ï–ñ–ò–ú ‚è±Ô∏è)**</p>
            <p>–ó–∞–º—ñ—Ä—è–Ω–∏–π –ß–∞—Å (t): <strong>${detailedTimeResult}</strong></p>
            <p>–†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –Ü–º–ø—É–ª—å—Å—ñ–≤ (N): <strong>${N_pulses.toFixed(2)} —ñ–º–ø</strong></p>`;

        referenceDiv.innerHTML = generateReferenceHTML('pulses', U, I, P_measured, C, null, timeMs, P_kW_calculated, N_pulses, t_hours);
    }

    function calculate() {
        const calcMode = document.querySelector('input[name="calculationMode"]:checked').value;
        const resultDiv = document.getElementById('result');
        const referenceDiv = document.getElementById('reference');


        const U = parseFloat(document.getElementById('voltage').value); 
        const I = parseFloat(document.getElementById('current').value); 
        const C = parseFloat(document.getElementById('meterConstant').value); 
        const N = parseFloat(document.getElementById('pulses').value); 
        const P_measured = parseFloat(document.getElementById('powerMeasured').value);
        
        const powerMeasuredInput = document.getElementById('powerMeasured');

        // === –õ–û–ì–Ü–ö–ê –î–ò–ù–ê–ú–Ü–ß–ù–û–ì–û PLACEHOLDER –î–õ–Ø –ü–û–¢–£–ñ–ù–û–°–¢–Ü (P) ===
        let impliedP = null;
        if (!isNaN(U) && !isNaN(I) && U > 0 && I > 0) {
            impliedP = (U * I) / 1000;
        } 
        
        if (powerMeasuredInput.value === '') {
            if (impliedP !== null) {
                powerMeasuredInput.placeholder = `–†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–µ: ${impliedP.toFixed(3)} –∫–í—Ç`;
            } else {
                powerMeasuredInput.placeholder = "–ù–∞–ø—Ä–∏–∫–ª–∞–¥ 1.5 (–∑–∞–º—ñ—Å—Ç—å U —Ç–∞ I)";
            }
        } 
        // =========================================================

        if (isNaN(C)) {
            resultDiv.innerHTML = "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å **–ü–æ—Å—Ç—ñ–π–Ω—É** –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞.";
            referenceDiv.innerHTML = "–í–≤–µ–¥—ñ—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É.";
            return;
        }
        
        const P_kW_calculated = calculatePower(U, I, P_measured);

        if (calcMode === 'pulses') {
            if (P_kW_calculated !== null && P_kW_calculated > 0) {
                 resultDiv.innerHTML = `**–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å** –≤–∏–∑–Ω–∞—á–µ–Ω–∞: **${P_kW_calculated.toFixed(3)} –∫–í—Ç**. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **–°–¢–ê–†–¢** –¥–ª—è –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è —á–∞—Å—É.`;
                 referenceDiv.innerHTML = generateReferenceHTML('pulses', U, I, P_measured, C, null, null, P_kW_calculated, null, null);
            } else {
                 resultDiv.innerHTML = "–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ **U** —Ç–∞ **I**, –∞–±–æ **P** —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å **–°–¢–ê–†–¢**.";
                 referenceDiv.innerHTML = "–í–≤–µ–¥—ñ—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É.";
            }
            
            return;
        }
        
        if (calcMode === 'time') {
            if (isNaN(N) || N <= 0) {
                 resultDiv.innerHTML = "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É **–ö—ñ–ª—å–∫—ñ—Å—Ç—å –Ü–º–ø—É–ª—å—Å—ñ–≤ (N)**.";
                 referenceDiv.innerHTML = "–í–≤–µ–¥—ñ—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É.";
                 return;
            }

            if (P_kW_calculated === null || P_kW_calculated <= 0) {
                resultDiv.innerHTML = "‚ùå **–ü–æ–º–∏–ª–∫–∞:** –í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è **–ü–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ (P)** –ê–ë–û –∑–∞–ø–æ–≤–Ω—ñ—Ç—å **–ù–∞–ø—Ä—É–≥—É (U)** —Ç–∞ **–°—Ç—Ä—É–º (I)**.";
                referenceDiv.innerHTML = "–í–≤–µ–¥—ñ—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É.";
                return;
            }

            const E_kWh = N / C; 
            const t_hours = E_kWh / P_kW_calculated;

            const detailedTimeDisplay = formatHoursMinutesSeconds(t_hours);

            resultDiv.innerHTML = `
                <p>‚úÖ **–†–û–ó–†–ê–•–£–ù–û–ö –ó–ê –Ü–ú–ü–£–õ–¨–°–ê–ú–ò (–†–ï–ñ–ò–ú üìä)**</p>
                <p>–í–≤–µ–¥–µ–Ω–∞ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –Ü–º–ø—É–ª—å—Å—ñ–≤ (N): <strong>${N} —ñ–º–ø</strong></p>
                <p>–†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∏–π –ß–∞—Å (t): <strong>${detailedTimeDisplay}</strong></p>`;

            referenceDiv.innerHTML = generateReferenceHTML('time', U, I, P_measured, C, N, null, P_kW_calculated, null, t_hours);
        }
    }

    // --- –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('modePulses').checked = true;
        
        checkAndToggleFilled('voltage');
        checkAndToggleFilled('current');
        checkAndToggleFilled('powerMeasured');
        checkAndToggleFilled('meterConstant'); 
        
        calculate(); 
        toggleCalcInputs();
    });
</script>

</body>
</html>